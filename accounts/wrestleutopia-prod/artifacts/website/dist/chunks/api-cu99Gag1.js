import"./roles-CaKbrTUl.js";import{fetchAuthSession as f}from"https://esm.sh/aws-amplify@6/auth";function w(t,a){if(!t)throw new Error("WU_API base URL missing");return a?t.replace(/\/+$/,"")+"/"+String(a).replace(/^\/+/,""):t}async function y(){var a,o,r,s;const t=await f();return((o=(a=t==null?void 0:t.tokens)==null?void 0:a.idToken)==null?void 0:o.toString())||((s=(r=t==null?void 0:t.tokens)==null?void 0:r.accessToken)==null?void 0:s.toString())||""}async function l(t){window.SparkMD5||await new Promise((n,d)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/spark-md5@3.0.2/spark-md5.min.js",i.onload=n,i.onerror=d,document.head.appendChild(i)});const a=2*1024*1024,o=Math.ceil(t.size/a),r=new window.SparkMD5.ArrayBuffer;for(let n=0;n<o;n++){const d=await t.slice(n*a,Math.min((n+1)*a,t.size)).arrayBuffer();r.append(d)}const s=r.end(),c=new Uint8Array(s.length/2);for(let n=0;n<c.length;n++)c[n]=parseInt(s.substr(n*2,2),16);let e="";for(let n=0;n<c.length;n++)e+=String.fromCharCode(c[n]);return btoa(e)}async function p(t,{method:a="GET",body:o=null,headers:r={}}={}){const s=await y(),c={...r};s&&(c.Authorization=`Bearer ${s}`),o!=null&&(c["content-type"]="application/json");const e=o!=null,n=await fetch(w(window.WU_API,t),{method:a,headers:c,body:e?JSON.stringify(o):null});if(!n.ok){let i=n.statusText;try{const u=await n.text();if(u)try{i=JSON.parse(u).message||u}catch{i=u}}catch{}throw new Error(`API ${n.status}: ${i}`)}return n.status===204||n.status===205||n.status===304?null:(n.headers.get("content-type")||"").includes("application/json")?n.json():await n.text().catch(()=>"")||null}async function T(t){const a=await l(t),o=await p(`/profiles/wrestlers/me/photo-url?contentType=${encodeURIComponent(t.type||"application/octet-stream")}`,{method:"POST",headers:{"Content-MD5":a}}),r=o==null?void 0:o.uploadUrl,s=o==null?void 0:o.objectKey,c=(o==null?void 0:o.contentType)||t.type||"application/octet-stream";if(!r||!s)throw new Error("presign failed");const e=await fetch(r,{method:"PUT",headers:{"Content-Type":c,"x-amz-server-side-encryption":"AES256","Content-MD5":a},body:t});if(!e.ok)throw new Error(`S3 upload failed ${e.status}: ${await e.text().catch(()=>e.statusText)}`);return s}async function k(t,a,o,r={}){const s=await l(o),c=new URLSearchParams({key:t||"upload.bin",contentType:a||"application/octet-stream"});r.actor&&c.set("actor",String(r.actor)),r.type&&c.set("type",String(r.type));const e=await p(`/s3/presign?${c.toString()}`,{method:"GET",headers:{"Content-MD5":s}}),n=(e==null?void 0:e.uploadUrl)||(e==null?void 0:e.url)||(e==null?void 0:e.signedUrl),d=(e==null?void 0:e.objectKey)||(e==null?void 0:e.key),i=(e==null?void 0:e.contentType)||a||"application/octet-stream";if(!n||!d)throw console.error("presign response:",e),new Error("Failed to get presigned URL (missing uploadUrl/objectKey)");const u=await fetch(n,{method:"PUT",headers:{"Content-Type":i,"x-amz-server-side-encryption":"AES256","Content-MD5":s},body:o});if(!u.ok){const h=await u.text().catch(()=>"");throw new Error(`S3 upload failed ${u.status}: ${h||u.statusText}`)}return d}function U(t){return Array.isArray(t)?t:t&&Array.isArray(t.items)?t.items:[]}window.WU_API_READY=!0;export{p as a,U as b,T as c,k as u};
